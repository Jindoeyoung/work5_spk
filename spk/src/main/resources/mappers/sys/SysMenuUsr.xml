<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spk.api.mapper.SysMenuUsrMapper">

	<!-- 시스템메뉴유저 조회  -->
    <select id="getSysMenuUsrList" resultType="com.spk.api.entity.SysMenuUsr">
		SELECT a.MENU_ID, a.MENU_NM, a.SEQ, a.LEVEL, b.USE_YN, a.PARENT_MENU_ID, a.ISDIRECTORY 
		FROM SYS_MENU_MST a left join SYS_MENU_USR b on a.DIVISION = b.DIVISION and a.MENU_ID = b.MENU_ID and a.SEQ = b.SEQ
		WHERE b.SPIKE_ID = #{SYS_MENU_USR.spike_id}
		<!--AND b.USE_YN = 'Y'-->
		ORDER BY a.DIVISION DESC, a.SEQ   
    </select>
    
	<!-- 시스템메뉴유저 조회 : 부서별 메뉴조회 적용  -->
    <select id="getSysMenuUsrList2" resultType="com.spk.api.entity.SysMenuUsr">
		SELECT x.MENU_ID, x.MENU_NM, x.SEQ, x.LEVEL, x.USE_YN, x.PARENT_MENU_ID, x.ISDIRECTORY, x.DIVISION
		FROM
		(
			SELECT distinct a.MENU_ID, a.MENU_NM, a.SEQ, a.LEVEL, b.USE_YN, a.PARENT_MENU_ID, a.ISDIRECTORY, a.DIVISION
			FROM SYS_MENU_MST a
			join SYS_MENU_USR b on a.DIVISION = b.DIVISION and a.MENU_ID = b.MENU_ID and a.SEQ = b.SEQ
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == 'DIGICAPS')">
			join SYS_MENU_AUTH c on a.DIVISION = c.DIVISION and a.MENU_ID = c.MENU_ID
			</if>
			WHERE b.SPIKE_ID = #{SYS_MENU_USR.spike_id}
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == 'DIGICAPS')">
			and ( c.depart_cd = #{SYS_MENU_USR.dept} or c.depart_cd = ( CASE WHEN #{SYS_MENU_USR.dept} = '0040' then 'ALL'    
										                       				 WHEN #{SYS_MENU_USR.dept} = '0020' then 'ALL'
										                      	 			 WHEN #{SYS_MENU_USR.dept} = '2000' then 'ALL' end ) )
			</if>							                      	 			 
		) x
		ORDER BY x.DIVISION DESC, x.SEQ 
    </select>
    
	<!-- 시스템메뉴유저 조회 : OWNER 추가 -->
    <select id="getSysMenuUsrList3" resultType="com.spk.api.entity.SysMenuUsr">
		SELECT x.MENU_ID, x.MENU_NM, x.SEQ, x.LEVEL, x.USE_YN, x.PARENT_MENU_ID, x.ISDIRECTORY, x.DIVISION,
			   case when x.ISDIRECTORY is null then x.OWNER else null end OWNER
		FROM
		(
			SELECT distinct a.MENU_ID, a.MENU_NM, a.SEQ, a.LEVEL, b.USE_YN, a.PARENT_MENU_ID, a.ISDIRECTORY, a.DIVISION, a.OWNER
			FROM SYS_MENU_MST a
			join SYS_MENU_USR_2 b on a.DIVISION = b.DIVISION and a.MENU_ID = b.MENU_ID and a.SEQ = b.SEQ
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == '01')">
			join SYS_MENU_AUTH_3 c on a.DIVISION = c.DIVISION and a.MENU_ID = c.MENU_ID
			</if>
			WHERE b.SPIKE_ID = #{SYS_MENU_USR.spike_id}
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == '01')">
			AND c.depart_cd = #{SYS_MENU_USR.dept}
			</if>							                      	 			 
		) x
		ORDER BY x.DIVISION DESC, x.SEQ 
    </select>    
    
	<!-- 시스템메뉴유저 조회 : 감리준비 -->
    <select id="getSysMenuUsrList_GR" resultType="com.spk.api.entity.SysMenuUsr">
		SELECT x.MENU_ID, x.MENU_NM, x.SEQ, x.LEVEL, x.USE_YN, x.PARENT_MENU_ID, x.ISDIRECTORY, x.DIVISION,
			   case when x.ISDIRECTORY is null then x.OWNER else null end OWNER
		FROM
		(
			SELECT distinct a.MENU_ID,
				<if test="(SYS_MENU_USR.dept == '84')"> <!-- 교수의 학부/대학원 명칭을 위함 -->
				CASE WHEN a.SEQ = 510 THEN '학부'
					 WHEN a.SEQ = 1337 THEN '대학원'
					 ELSE a.MENU_NM end as MENU_NM,
				</if>
				<if test="!(SYS_MENU_USR.dept == '84')">
				a.MENU_NM,
				</if>
			a.SEQ, a.LEVEL, b.USE_YN, a.PARENT_MENU_ID, a.ISDIRECTORY, a.DIVISION, a.OWNER
			FROM SYS_MENU_MST_GR a
			join SYS_MENU_USR_GR b on a.DIVISION = b.DIVISION and a.MENU_ID = b.MENU_ID and a.SEQ = b.SEQ
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == '01')"> <!-- SUPER 가 아닐경우만 -->
			join SYS_MENU_AUTH_GR c on a.DIVISION = c.DIVISION and a.MENU_ID = c.MENU_ID
			</if>
			WHERE b.SPIKE_ID = #{SYS_MENU_USR.spike_id}
			<if test="(SYS_MENU_USR.dept == '84')"> <!-- 교수의 학부/대학원 LEVEL 을 맞추기 위한조건 -->
			  AND a.SEQ NOT IN (
			                     1
			                    ,474
			                    ,1001
			                    ,1306
			                    )
			</if>
			<if test="(SYS_MENU_USR.dept == '81' or SYS_MENU_USR.dept == '90')"> <!-- 학부생의 ROOT LEVEL 을 맞추기 위한조건 -->
			  AND a.SEQ NOT IN (
			                    1 
			                    ,474
			                    ,475
			                    )
			</if>			
			<if test="(SYS_MENU_USR.dept == '85')"> <!-- 대학원생의 ROOT LEVEL 을 맞추기 위한조건 -->
			  AND a.SEQ NOT IN (
			                    1001
			                   ,1306
			                   ,1307
			                   )
			</if>			
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == '01')"> <!-- SUPER 가 아닐경우만 -->
			AND c.depart_cd = #{SYS_MENU_USR.dept}
			</if>							                      	 			 
		) x
		ORDER BY x.DIVISION DESC, x.SEQ 
    </select>    
    
    
	<!-- 시스템메뉴유저 조회 : 감리준비 
    <select id="getSysMenuUsrList_GR2" resultType="com.spk.api.entity.SysMenuUsr">
		SELECT x.MENU_ID, x.MENU_NM, x.SEQ, x.LEVEL, x.USE_YN, x.PARENT_MENU_ID, x.ISDIRECTORY, x.DIVISION,
			   case when x.ISDIRECTORY is null then x.OWNER else null end OWNER
		FROM
		(
			SELECT distinct a.MENU_ID,
				<if test="(SYS_MENU_USR.dept == '84' or SYS_MENU_USR.dept == '0040' or SYS_MENU_USR.dept == '2000' or SYS_MENU_USR.dept == '0020' or SYS_MENU_USR.dept == '0035' or SYS_MENU_USR.dept == '0044')">
				CASE WHEN a.SEQ = 510 THEN '학부'
					 WHEN a.SEQ = 1337 THEN '대학원'
					 ELSE a.MENU_NM end as MENU_NM,
				</if>
				<if test="!(SYS_MENU_USR.dept == '84' or SYS_MENU_USR.dept == '0040' or SYS_MENU_USR.dept == '2000' or SYS_MENU_USR.dept == '0020' or SYS_MENU_USR.dept == '0035' or SYS_MENU_USR.dept == '0044')">
				a.MENU_NM,
				</if>
			a.SEQ, a.LEVEL, b.USE_YN, a.PARENT_MENU_ID, a.ISDIRECTORY, a.DIVISION, a.OWNER
			FROM SYS_MENU_MST_GR2 a
			join SYS_MENU_USR_GR2 b on a.DIVISION = b.DIVISION and a.MENU_ID = b.MENU_ID and a.SEQ = b.SEQ
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == '01')">
			join SYS_MENU_AUTH_GR2 c on a.DIVISION = c.DIVISION and a.MENU_ID = c.MENU_ID
			</if>
			WHERE b.SPIKE_ID = #{SYS_MENU_USR.spike_id}
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == '01')">
			  AND c.depart_cd = #{SYS_MENU_USR.dept}
			</if>  
			  AND a.DIVISION = 'W'
		) x
		ORDER BY x.DIVISION DESC, x.SEQ 
    </select>    
    -->

	<!-- 시스템메뉴유저 조회 : 감리준비 --> <!-- 테이블만 G3 
    <select id="getSysMenuUsrList_GR2" resultType="com.spk.api.entity.SysMenuUsr">
		SELECT x.MENU_ID, x.MENU_NM, x.SEQ, x.LEVEL, x.USE_YN, x.PARENT_MENU_ID, x.ISDIRECTORY, x.DIVISION,
			   case when x.ISDIRECTORY is null then x.OWNER else null end OWNER
		FROM
		(
			SELECT distinct a.MENU_ID,
				<if test="(SYS_MENU_USR.dept == '84' or SYS_MENU_USR.dept == '0040' or SYS_MENU_USR.dept == '2000' or SYS_MENU_USR.dept == '0020' or SYS_MENU_USR.dept == '0035' or SYS_MENU_USR.dept == '0044')">
				CASE WHEN a.SEQ = 510 THEN '학부'
					 WHEN a.SEQ = 1337 THEN '대학원'
					 ELSE a.MENU_NM end as MENU_NM,
				</if>
				<if test="!(SYS_MENU_USR.dept == '84' or SYS_MENU_USR.dept == '0040' or SYS_MENU_USR.dept == '2000' or SYS_MENU_USR.dept == '0020' or SYS_MENU_USR.dept == '0035' or SYS_MENU_USR.dept == '0044')">
				a.MENU_NM,
				</if>
			a.SEQ, a.LEVEL, b.USE_YN, a.PARENT_MENU_ID, a.ISDIRECTORY, a.DIVISION, a.OWNER
			FROM SYS_MENU_MST_GR3 a
			join SYS_MENU_USR_GR3 b on a.DIVISION = b.DIVISION and a.MENU_ID = b.MENU_ID and a.SEQ = b.SEQ
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == '01')">
			join SYS_MENU_AUTH_GR3 c on a.DIVISION = c.DIVISION and a.MENU_ID = c.MENU_ID
			</if>
			WHERE b.SPIKE_ID = #{SYS_MENU_USR.spike_id}
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == '01')">
			  AND c.depart_cd = #{SYS_MENU_USR.dept}
			</if>  
			  AND a.DIVISION NOT IN ('Y', 'Z')
		) x
		ORDER BY x.DIVISION DESC, x.SEQ 
    </select>    
     -->
     
	<!-- 시스템메뉴유저 조회 --> <!-- 기숙사신청조회 메뉴 추가 관련 -->
    <select id="getSysMenuUsrList_GR2" resultType="com.spk.api.entity.SysMenuUsr">
		SELECT x.MENU_ID, x.MENU_NM, x.SEQ, x.LEVEL, x.USE_YN, x.PARENT_MENU_ID, x.ISDIRECTORY, x.DIVISION,
			   case when x.ISDIRECTORY is null then x.OWNER else null end OWNER
		FROM
		(
			SELECT distinct a.MENU_ID,
				<if test="(SYS_MENU_USR.dept == '84' or SYS_MENU_USR.dept == '0040' or SYS_MENU_USR.dept == '2000' or SYS_MENU_USR.dept == '0020' or SYS_MENU_USR.dept == '0035' or SYS_MENU_USR.dept == '0044')"> <!-- 교수/직원의 학부/대학원 명칭을 위함 -->
				CASE WHEN a.SEQ = '510' THEN '학부'   <!-- 교원 -> 학부로 뷰잉 -->
					 WHEN a.SEQ = '1337' THEN '대학원' <!-- 교원 -> 학부로 뷰잉 -->
					 ELSE a.MENU_NM end as MENU_NM,
				</if>
				<if test="!(SYS_MENU_USR.dept == '84' or SYS_MENU_USR.dept == '0040' or SYS_MENU_USR.dept == '2000' or SYS_MENU_USR.dept == '0020' or SYS_MENU_USR.dept == '0035' or SYS_MENU_USR.dept == '0044')"> <!-- 교수/직원이 아닌, 학부/교환학생/대학원생 학부/대학원 명칭을 위함 -->
				a.MENU_NM,
				</if>
			a.SEQ, a.LEVEL, b.USE_YN, a.PARENT_MENU_ID, a.ISDIRECTORY, a.DIVISION, a.OWNER
			FROM SYS_MENU_MST_4 a
			JOIN SYS_MENU_USR_4 b on a.DIVISION = b.DIVISION and a.MENU_ID = b.MENU_ID
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == '01')"> <!-- SUPER 가 아닐경우만 -->
			join SYS_MENU_AUTH_GR3 c on a.DIVISION = c.DIVISION and a.MENU_ID = c.MENU_ID
			</if>
			WHERE b.SPIKE_ID = #{SYS_MENU_USR.spike_id}
			<if test="!(SYS_MENU_USR.dept == '0070' or SYS_MENU_USR.dept == '01')"> <!-- SUPER 가 아닐경우만 -->
			  AND c.depart_cd = #{SYS_MENU_USR.dept}
			</if>  
			  AND a.DIVISION NOT IN ('Y', 'Z', 'X')
		) x
		ORDER BY x.DIVISION DESC, x.SEQ 
    </select>
    
	<!-- 시스템메뉴유저 상세조회  -->
    <select id="getSysMenuUsrInfo" resultType="com.spk.api.entity.SysMenuUsr">
        SELECT * FROM SYS_MENU_USR 
        WHERE SPIKE_ID = #{SYS_MENU_USR.spike_id}
          AND DIVISION = #{SYS_MENU_USR.division}
		  AND MENU_ID = #{SYS_MENU_USR.menu_id}	
    </select>    
    
	<!-- 시스템메뉴유저 수정  -->
    <update id="updateUseYn" parameterType="com.spk.api.entity.SysMenuUsr">
        UPDATE SYS_MENU_USR
           SET USE_YN =  #{SYS_MENU_USR.use_yn} 
         WHERE SPIKE_ID = #{SYS_MENU_USR.spike_id}
           AND DIVISION = #{SYS_MENU_USR.division}
           AND MENU_ID = #{SYS_MENU_USR.menu_id}
    </update>    
    
</mapper>